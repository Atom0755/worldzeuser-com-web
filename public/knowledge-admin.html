<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çŸ¥è¯†åº“ç®¡ç† - USCGCC</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    textarea {
      min-height: 200px;
      resize: vertical;
      font-family: inherit;
    }
    
    .btn {
      background: #667eea;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #6c757d;
      margin-left: 10px;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .knowledge-list {
      margin-top: 20px;
    }
    
    .knowledge-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border: 2px solid #e9ecef;
      transition: all 0.3s;
    }
    
    .knowledge-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    
    .knowledge-item h3 {
      margin-bottom: 10px;
      color: #333;
      font-size: 18px;
    }
    
    .knowledge-item p {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .actions {
      display: flex;
      gap: 10px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 32px;
      margin-bottom: 5px;
    }
    
    .stat-card p {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“š USCGCC çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿ</h1>
      <p>ç®¡ç†å•†ä¼š AI åŠ©æ‰‹çš„çŸ¥è¯†åº“å†…å®¹</p>
    </div>

    <div id="alert"></div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats">
      <div class="stat-card">
        <h3 id="totalCount">-</h3>
        <p>æ€»æ¡ç›®æ•°</p>
      </div>
      <div class="stat-card">
        <h3 id="withEmbedding">-</h3>
        <p>å·²ç”Ÿæˆå‘é‡</p>
      </div>
      <div class="stat-card">
        <h3 id="pendingEmbedding">-</h3>
        <p>å¾…å¤„ç†</p>
      </div>
    </div>

    <!-- æ·»åŠ çŸ¥è¯†åº“è¡¨å• -->
    <div class="card">
      <h2>â• æ·»åŠ æ–°çŸ¥è¯†</h2>
      <form id="addForm">
        <div class="form-group">
          <label for="title">æ ‡é¢˜ *</label>
          <input type="text" id="title" required placeholder="ä¾‹å¦‚ï¼šå•†ä¼šç®€ä»‹">
        </div>

        <div class="form-group">
          <label for="category">åˆ†ç±»</label>
          <select id="category">
            <option value="å•†ä¼šç®€ä»‹">å•†ä¼šç®€ä»‹</option>
            <option value="æ€»ä¼šé•¿ç®€ä»‹">æ€»ä¼šé•¿ç®€ä»‹</option>
            <option value="ç§˜ä¹¦é•¿ç®€ä»‹">ç§˜ä¹¦é•¿ç®€ä»‹</option>
            <option value="å…¥ä¼šæŒ‡å—">å…¥ä¼šæŒ‡å—</option>
            <option value="åˆ›å§‹å•ä½">åˆ›å§‹å•ä½</option>
            <option value="è”ç³»æˆ‘ä»¬">è”ç³»æˆ‘ä»¬</option>
            <option value="å•†ä¼šåŠ¨æ€">å•†ä¼šåŠ¨æ€</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label for="content">å†…å®¹ *</label>
          <textarea id="content" required placeholder="è¯·è¾“å…¥çŸ¥è¯†åº“å†…å®¹...æ”¯æŒæ¢è¡Œå’Œé•¿æ–‡æœ¬"></textarea>
        </div>

        <button type="submit" class="btn" id="submitBtn">ğŸ’¾ ä¿å­˜å¹¶ç”Ÿæˆå‘é‡</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('addForm').reset()">ğŸ”„ æ¸…ç©º</button>
      </form>
    </div>

    <!-- çŸ¥è¯†åº“åˆ—è¡¨ -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2>ğŸ“‹ ç°æœ‰çŸ¥è¯†åº“</h2>
        <div style="display:flex;gap:10px;">
          <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ ‡é¢˜æˆ–å†…å®¹..." style="width:300px;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <select id="filterCategory" style="padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
            <option value="">å…¨éƒ¨åˆ†ç±»</option>
            <option value="å•†ä¼šç®€ä»‹">å•†ä¼šç®€ä»‹</option>
            <option value="æ€»ä¼šé•¿ç®€ä»‹">æ€»ä¼šé•¿ç®€ä»‹</option>
            <option value="ç§˜ä¹¦é•¿ç®€ä»‹">ç§˜ä¹¦é•¿ç®€ä»‹</option>
            <option value="å…¥ä¼šæŒ‡å—">å…¥ä¼šæŒ‡å—</option>
            <option value="åˆ›å§‹å•ä½">åˆ›å§‹å•ä½</option>
            <option value="è”ç³»æˆ‘ä»¬">è”ç³»æˆ‘ä»¬</option>
            <option value="å•†ä¼šåŠ¨æ€">å•†ä¼šåŠ¨æ€</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
      </div>
      <div id="knowledgeList" class="knowledge-list">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ– Supabase
    const SUPABASE_URL = 'https://hrnedqrnzqseuuxmegsb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhybmVkcXJuenFzZXV1eG1lZ3NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MDMzOTYsImV4cCI6MjA1MjA3OTM5Nn0.2AwbeB0xIdHwNILQ3Fg9dPHCEm6QczRPCFMu_hKjqPk';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const TENANT_SLUG = 'uscgcc';

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(message, type = 'success') {
      const alertDiv = document.getElementById('alert');
      alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => {
        alertDiv.innerHTML = '';
      }, 5000);
    }

    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    async function loadStats() {
      try {
        const { data, error } = await supabase
          .from('knowledge_base')
          .select('id, embedding')
          .eq('tenant_slug', TENANT_SLUG);

        if (error) throw error;

        const total = data.length;
        const withEmbedding = data.filter(item => item.embedding !== null).length;
        const pending = total - withEmbedding;

        document.getElementById('totalCount').textContent = total;
        document.getElementById('withEmbedding').textContent = withEmbedding;
        document.getElementById('pendingEmbedding').textContent = pending;
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
      }
    }

    // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
    async function loadKnowledge() {
      const listDiv = document.getElementById('knowledgeList');
      listDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        // è·å–æœç´¢å’Œè¿‡æ»¤æ¡ä»¶
        const searchText = document.getElementById('searchInput')?.value.toLowerCase() || '';
        const filterCat = document.getElementById('filterCategory')?.value || '';

        let query = supabase
          .from('knowledge_base')
          .select('*')
          .eq('tenant_slug', TENANT_SLUG);
        
        // å¦‚æœæœ‰åˆ†ç±»è¿‡æ»¤
        if (filterCat) {
          query = query.eq('category', filterCat);
        }
        
        query = query.order('created_at', { ascending: false });

        const { data, error } = await query;

        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }

        console.log('åŠ è½½çš„æ•°æ®:', data); // è°ƒè¯•æ—¥å¿—

        // å‰ç«¯æœç´¢è¿‡æ»¤
        let filteredData = data || [];
        if (searchText) {
          filteredData = filteredData.filter(item => 
            (item.title && item.title.toLowerCase().includes(searchText)) ||
            (item.content && item.content.toLowerCase().includes(searchText))
          );
        }

        if (filteredData.length === 0) {
          const msg = searchText || filterCat 
            ? 'ğŸ“­ æœªæ‰¾åˆ°åŒ¹é…çš„çŸ¥è¯†<br><small style="color:#999;">è¯•è¯•å…¶ä»–æœç´¢è¯æˆ–æ¸…ç©ºç­›é€‰æ¡ä»¶</small>'
            : 'ğŸ“­ æš‚æ— çŸ¥è¯†åº“å†…å®¹<br><small style="color:#999;">è¯·ä½¿ç”¨ä¸Šæ–¹è¡¨å•æ·»åŠ æ–°çŸ¥è¯†</small>';
          listDiv.innerHTML = `<p style="text-align:center;color:#666;padding:40px;">${msg}</p>`;
          return;
        }

        listDiv.innerHTML = filteredData.map(item => `
          <div class="knowledge-item">
            <div style="flex:1;">
              <h3>
                ${escapeHtml(item.title || 'æ— æ ‡é¢˜')}
                ${item.category ? `<span class="badge badge-success">${escapeHtml(item.category)}</span>` : ''}
                ${item.embedding ? '<span class="badge badge-success">âœ“ å·²ç”Ÿæˆå‘é‡</span>' : '<span class="badge badge-warning">â³ å¾…å¤„ç†</span>'}
              </h3>
              <p style="margin:10px 0;line-height:1.6;">${escapeHtml((item.content || '').substring(0, 150))}${item.content && item.content.length > 150 ? '...' : ''}</p>
              <small style="color:#999;">ğŸ“… åˆ›å»ºäº: ${new Date(item.created_at).toLocaleString('zh-CN')}</small>
            </div>
            <div class="actions">
              <button class="btn" onclick="viewKnowledge('${item.id}', \`${escapeHtml(item.title || '').replace(/'/g, "\\'")\``, \`${escapeHtml((item.content || '').replace(/`/g, '').replace(/'/g, "\\'")).substring(0, 5000)}\`)">ğŸ‘ï¸ æŸ¥çœ‹</button>
              <button class="btn btn-danger" onclick="deleteKnowledge('${item.id}', \`${escapeHtml(item.title || '').replace(/'/g, "\\'")\``)\">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥:', error);
        listDiv.innerHTML = `
          <div style="text-align:center;padding:40px;">
            <p style="color:red;margin-bottom:10px;">âŒ åŠ è½½å¤±è´¥</p>
            <p style="color:#666;font-size:14px;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
            <button class="btn" onclick="loadKnowledge()" style="margin-top:20px;">ğŸ”„ é‡æ–°åŠ è½½</button>
          </div>
        `;
      }
    }

    // HTML è½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ç”Ÿæˆ Embedding
    async function generateEmbedding() {
      try {
        const response = await supabase.functions.invoke('embed-backfill', {
          body: { tenant_slug: TENANT_SLUG, limit: 50 }
        });

        if (response.error) throw response.error;
        
        showAlert('âœ… å‘é‡ç”ŸæˆæˆåŠŸï¼', 'success');
        loadStats();
        loadKnowledge();
      } catch (error) {
        console.error('ç”Ÿæˆå‘é‡å¤±è´¥:', error);
        showAlert('âŒ å‘é‡ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ·»åŠ çŸ¥è¯†åº“
    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'ä¿å­˜ä¸­...';

      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const category = document.getElementById('category').value;

      try {
        // 1. æ’å…¥æ•°æ®
        const { data, error } = await supabase
          .from('knowledge_base')
          .insert([
            {
              tenant_slug: TENANT_SLUG,
              title: title,
              content: content,
              category: category,
              content_type: 'text'
            }
          ])
          .select();

        if (error) throw error;

        showAlert('âœ… ä¿å­˜æˆåŠŸï¼æ­£åœ¨ç”Ÿæˆå‘é‡...', 'success');

        // 2. ç”Ÿæˆ Embedding
        await generateEmbedding();

        // 3. æ¸…ç©ºè¡¨å•
        document.getElementById('addForm').reset();
        
        // 4. åˆ·æ–°åˆ—è¡¨
        loadKnowledge();
        loadStats();

      } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        showAlert('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ ä¿å­˜å¹¶ç”Ÿæˆå‘é‡';
      }
    });

    // æŸ¥çœ‹çŸ¥è¯†è¯¦æƒ…
    function viewKnowledge(id, title, content) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="background:white;border-radius:10px;padding:30px;max-width:800px;max-height:80vh;overflow-y:auto;width:100%;">
          <h2 style="margin-bottom:20px;color:#333;">${title}</h2>
          <div style="white-space:pre-wrap;line-height:1.8;color:#555;">${content}</div>
          <button class="btn" onclick="this.closest('div').parentElement.remove()" style="margin-top:20px;">å…³é—­</button>
        </div>
      `;
      
      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
      
      document.body.appendChild(modal);
    }

    // åˆ é™¤çŸ¥è¯†åº“
    async function deleteKnowledge(id, title) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤"${title}"å—ï¼Ÿ\n\nåˆ é™¤åæ— æ³•æ¢å¤ï¼`)) return;

      try {
        const { error } = await supabase
          .from('knowledge_base')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showAlert(`âœ… å·²åˆ é™¤"${title}"`, 'success');
        loadKnowledge();
        loadStats();
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        showAlert('âŒ åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
      loadStats();
      loadKnowledge();
      
      // æ·»åŠ æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
      const searchInput = document.getElementById('searchInput');
      const filterCategory = document.getElementById('filterCategory');
      
      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          loadKnowledge();
        }, 500);
      });
      
      filterCategory.addEventListener('change', () => {
        loadKnowledge();
      });
    });
  </script>
</body>
</html>
