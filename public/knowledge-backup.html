<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çŸ¥è¯†åº“å¤‡ä»½ - USCGCC</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .description {
      color: #666;
      margin-bottom: 30px;
    }
    
    .btn-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .btn {
      background: #667eea;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
      background: #28a745;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-info {
      background: #17a2b8;
    }
    
    .btn-info:hover {
      background: #138496;
    }
    
    .info-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border-left: 4px solid #667eea;
    }
    
    .info-box h3 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .info-box p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 5px;
    }
    
    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 32px;
      margin-bottom: 5px;
    }
    
    .stat-card p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 14px;
      line-height: 1.5;
      border: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>
        ğŸ’¾ çŸ¥è¯†åº“å¤‡ä»½å·¥å…·
      </h1>
      <p class="description">å¯¼å‡ºå’Œå¤‡ä»½æ‚¨çš„ USCGCC çŸ¥è¯†åº“æ•°æ®</p>

      <div id="alert"></div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="stats">
        <div class="stat-card">
          <h3 id="totalCount">-</h3>
          <p>æ€»æ¡ç›®æ•°</p>
        </div>
        <div class="stat-card">
          <h3 id="lastBackup">ä»æœª</h3>
          <p>ä¸Šæ¬¡å¤‡ä»½</p>
        </div>
      </div>

      <!-- å¤‡ä»½æŒ‰é’® -->
      <div class="btn-group">
        <button class="btn btn-success" onclick="exportJSON()">
          ğŸ“„ å¯¼å‡ºä¸º JSON
        </button>
        <button class="btn btn-info" onclick="exportCSV()">
          ğŸ“Š å¯¼å‡ºä¸º CSV
        </button>
        <button class="btn" onclick="exportMarkdown()">
          ğŸ“ å¯¼å‡ºä¸º Markdown
        </button>
      </div>

      <!-- è¯´æ˜ -->
      <div class="info-box">
        <h3>ğŸ’¡ å¤‡ä»½è¯´æ˜</h3>
        <p><strong>JSON æ ¼å¼ï¼š</strong>åŒ…å«å®Œæ•´æ•°æ®ï¼Œé€‚åˆç¨‹åºå¤„ç†å’Œæ¢å¤</p>
        <p><strong>CSV æ ¼å¼ï¼š</strong>å¯ç”¨ Excel æ‰“å¼€ï¼Œé€‚åˆæŸ¥çœ‹å’Œç¼–è¾‘</p>
        <p><strong>Markdown æ ¼å¼ï¼š</strong>äººç±»å¯è¯»ï¼Œé€‚åˆæ–‡æ¡£å½’æ¡£</p>
      </div>
    </div>

    <!-- é¢„è§ˆåŒºåŸŸ -->
    <div class="card" id="previewCard" style="display:none;">
      <h2>ğŸ“‹ æ•°æ®é¢„è§ˆ</h2>
      <pre id="preview"></pre>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ– Supabase
    const SUPABASE_URL = 'https://hrnedqrnzqseuuxmegsb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhybmVkcXJuenFzZXV1eG1lZ3NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MDMzOTYsImV4cCI6MjA1MjA3OTM5Nn0.2AwbeB0xIdHwNILQ3Fg9dPHCEm6QczRPCFMu_hKjqPk';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TENANT_SLUG = 'uscgcc';

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(message, type = 'success') {
      const alertDiv = document.getElementById('alert');
      alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => {
        alertDiv.innerHTML = '';
      }, 5000);
    }

    // åŠ è½½ç»Ÿè®¡
    async function loadStats() {
      try {
        const { data, error } = await supabase
          .from('knowledge_base')
          .select('id')
          .eq('tenant_slug', TENANT_SLUG);

        if (error) throw error;

        document.getElementById('totalCount').textContent = data.length;
        
        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ä¸Šæ¬¡å¤‡ä»½æ—¶é—´
        const lastBackup = localStorage.getItem('lastBackup_uscgcc');
        if (lastBackup) {
          const date = new Date(lastBackup);
          document.getElementById('lastBackup').textContent = date.toLocaleDateString('zh-CN');
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
      }
    }

    // è·å–æ‰€æœ‰çŸ¥è¯†åº“æ•°æ®
    async function getAllData() {
      try {
        const { data, error } = await supabase
          .from('knowledge_base')
          .select('*')
          .eq('tenant_slug', TENANT_SLUG)
          .order('created_at', { ascending: false });

        if (error) throw error;
        return data;
      } catch (error) {
        console.error('è·å–æ•°æ®å¤±è´¥:', error);
        showAlert('âŒ è·å–æ•°æ®å¤±è´¥: ' + error.message, 'error');
        return null;
      }
    }

    // ä¸‹è½½æ–‡ä»¶
    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // è®°å½•å¤‡ä»½æ—¶é—´
      localStorage.setItem('lastBackup_uscgcc', new Date().toISOString());
      loadStats();
    }

    // å¯¼å‡ºä¸º JSON
    async function exportJSON() {
      const data = await getAllData();
      if (!data) return;

      // æ¸…ç† embedding å­—æ®µï¼ˆå¤ªå¤§ï¼‰
      const cleanData = data.map(item => ({
        ...item,
        embedding: item.embedding ? 'HAS_EMBEDDING' : null
      }));

      const json = JSON.stringify(cleanData, null, 2);
      const filename = `uscgcc-knowledge-backup-${new Date().toISOString().split('T')[0]}.json`;
      
      downloadFile(json, filename, 'application/json');
      showAlert('âœ… JSON æ–‡ä»¶å·²ä¸‹è½½ï¼', 'success');
      
      // æ˜¾ç¤ºé¢„è§ˆ
      document.getElementById('preview').textContent = json.substring(0, 500) + '...';
      document.getElementById('previewCard').style.display = 'block';
    }

    // å¯¼å‡ºä¸º CSV
    async function exportCSV() {
      const data = await getAllData();
      if (!data) return;

      // CSV å¤´éƒ¨
      const headers = ['ID', 'æ ‡é¢˜', 'åˆ†ç±»', 'å†…å®¹', 'åˆ›å»ºæ—¶é—´', 'æœ‰å‘é‡'];
      let csv = headers.join(',') + '\n';

      // CSV æ•°æ®
      data.forEach(item => {
        const row = [
          item.id,
          `"${(item.title || '').replace(/"/g, '""')}"`,
          `"${(item.category || '').replace(/"/g, '""')}"`,
          `"${(item.content || '').substring(0, 100).replace(/"/g, '""')}..."`,
          item.created_at,
          item.embedding ? 'æ˜¯' : 'å¦'
        ];
        csv += row.join(',') + '\n';
      });

      const filename = `uscgcc-knowledge-backup-${new Date().toISOString().split('T')[0]}.csv`;
      downloadFile('\uFEFF' + csv, filename, 'text/csv;charset=utf-8;');
      showAlert('âœ… CSV æ–‡ä»¶å·²ä¸‹è½½ï¼å¯ç”¨ Excel æ‰“å¼€', 'success');
    }

    // å¯¼å‡ºä¸º Markdown
    async function exportMarkdown() {
      const data = await getAllData();
      if (!data) return;

      let markdown = `# USCGCC çŸ¥è¯†åº“å¤‡ä»½\n\n`;
      markdown += `å¤‡ä»½æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n`;
      markdown += `æ€»æ¡ç›®æ•°ï¼š${data.length}\n\n`;
      markdown += `---\n\n`;

      data.forEach((item, index) => {
        markdown += `## ${index + 1}. ${item.title || 'æ— æ ‡é¢˜'}\n\n`;
        markdown += `**åˆ†ç±»ï¼š** ${item.category || 'æœªåˆ†ç±»'}\n\n`;
        markdown += `**åˆ›å»ºæ—¶é—´ï¼š** ${new Date(item.created_at).toLocaleString('zh-CN')}\n\n`;
        markdown += `**å†…å®¹ï¼š**\n\n${item.content || 'æ— å†…å®¹'}\n\n`;
        markdown += `**å‘é‡çŠ¶æ€ï¼š** ${item.embedding ? 'âœ… å·²ç”Ÿæˆ' : 'âŒ æœªç”Ÿæˆ'}\n\n`;
        markdown += `---\n\n`;
      });

      const filename = `uscgcc-knowledge-backup-${new Date().toISOString().split('T')[0]}.md`;
      downloadFile(markdown, filename, 'text/markdown;charset=utf-8;');
      showAlert('âœ… Markdown æ–‡ä»¶å·²ä¸‹è½½ï¼', 'success');
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
      loadStats();
    });
  </script>
</body>
</html>
