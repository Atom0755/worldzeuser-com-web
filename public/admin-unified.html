<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USCGCC ç®¡ç†åå°</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* ç™»å½•é¡µé¢ */
    #loginPage {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 100%;
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 15px;
    }

    .logo h2 {
      color: #333;
      margin-bottom: 5px;
    }

    .logo p {
      color: #666;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      background: #667eea;
      color: white;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #5568d3;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .alert {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* ç®¡ç†åå° */
    #adminPage {
      display: none;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-email {
      color: #666;
      font-size: 14px;
    }

    .btn-logout {
      background: #dc3545;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-logout:hover {
      background: #c82333;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      background: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tab:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      min-height: 150px;
      font-family: inherit;
      resize: vertical;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .btn-secondary {
      background: #6c757d;
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 32px;
      margin-bottom: 5px;
    }

    .stat-card p {
      font-size: 14px;
      opacity: 0.9;
    }

    .item-list {
      margin-top: 20px;
    }

    .item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
      transition: all 0.3s;
    }

    .item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }

    .item h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .item p {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .item-meta {
      display: flex;
      gap: 15px;
      align-items: center;
      font-size: 13px;
      color: #999;
      margin-bottom: 10px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µé¢ -->
  <div id="loginPage">
    <div class="login-card">
      <div class="logo">
        <img src="https://uscgcc.worldzeuser.com/logo.png" alt="USCGCC Logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23667eea%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2240%22 font-weight=%22bold%22%3ELOGO%3C/text%3E%3C/svg%3E'">
        <h2>USCGCC ç®¡ç†åå°</h2>
        <p>ç¾å›½ç²¤å•†ä¼šå†…å®¹ç®¡ç†ç³»ç»Ÿ</p>
      </div>

      <div id="loginAlert"></div>

      <form id="loginForm">
        <div class="form-group">
          <label for="email">ğŸ“§ ç®¡ç†å‘˜é‚®ç®±</label>
          <input type="email" id="email" required placeholder="admin@uscgcc.org">
        </div>

        <div class="form-group">
          <label for="password">ğŸ”’ å¯†ç </label>
          <input type="password" id="password" required placeholder="è¾“å…¥å¯†ç ">
        </div>

        <button type="submit" class="btn" id="loginBtn">ğŸ” ç™»å½•</button>
      </form>

      <div style="text-align: center; margin-top: 20px;">
        <a href="#" onclick="showRegisterPage(); return false;" style="color: #667eea; text-decoration: none; font-size: 14px; margin-right: 15px;">
          ğŸ“ æ³¨å†Œæ–°è´¦å·
        </a>
        <a href="#" onclick="showForgotPasswordPage(); return false;" style="color: #667eea; text-decoration: none; font-size: 14px;">
          ğŸ”‘ å¿˜è®°å¯†ç ï¼Ÿ
        </a>
      </div>
    </div>
  </div>

  <!-- æ³¨å†Œé¡µé¢ -->
  <div id="registerPage" style="display: none;">
    <div class="login-card">
      <div class="logo">
        <img src="https://uscgcc.worldzeuser.com/logo.png" alt="USCGCC Logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23667eea%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2240%22 font-weight=%22bold%22%3ELOGO%3C/text%3E%3C/svg%3E'">
        <h2>æ³¨å†Œç®¡ç†å‘˜è´¦å·</h2>
        <p>USCGCC å†…å®¹ç®¡ç†ç³»ç»Ÿ</p>
      </div>

      <div id="registerAlert"></div>

      <form id="registerForm">
        <div class="form-group">
          <label for="inviteCode">ğŸ« é‚€è¯·ç  *</label>
          <input type="text" id="inviteCode" required placeholder="è¾“å…¥é‚€è¯·ç " style="text-transform: uppercase;">
          <small style="color:#666;font-size:12px;">è¯·è¾“å…¥ç®¡ç†å‘˜æä¾›çš„é‚€è¯·ç </small>
        </div>

        <div class="form-group">
          <label for="regEmail">ğŸ“§ é‚®ç®±åœ°å€</label>
          <input type="email" id="regEmail" required placeholder="your.email@uscgcc.org">
        </div>

        <div class="form-group">
          <label for="regPassword">ğŸ”’ å¯†ç </label>
          <input type="password" id="regPassword" required placeholder="è‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—" minlength="8">
          <small style="color:#666;font-size:12px;">å»ºè®®ä½¿ç”¨å¼ºå¯†ç ï¼šå¤§å°å†™å­—æ¯+æ•°å­—+ç‰¹æ®Šå­—ç¬¦</small>
        </div>

        <div class="form-group">
          <label for="regPasswordConfirm">ğŸ”’ ç¡®è®¤å¯†ç </label>
          <input type="password" id="regPasswordConfirm" required placeholder="å†æ¬¡è¾“å…¥å¯†ç " minlength="8">
        </div>

        <button type="submit" class="btn" id="registerBtn">ğŸ“ æ³¨å†Œ</button>
      </form>

      <div style="text-align: center; margin-top: 20px;">
        <a href="#" onclick="showLoginPage(); return false;" style="color: #667eea; text-decoration: none; font-size: 14px;">
          â† è¿”å›ç™»å½•
        </a>
      </div>
    </div>
  </div>

  <!-- å¿˜è®°å¯†ç é¡µé¢ -->
  <div id="forgotPasswordPage" style="display: none;">
    <div class="login-card">
      <div class="logo">
        <img src="https://uscgcc.worldzeuser.com/logo.png" alt="USCGCC Logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23667eea%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2240%22 font-weight=%22bold%22%3ELOGO%3C/text%3E%3C/svg%3E'">
        <h2>é‡ç½®å¯†ç </h2>
        <p>æˆ‘ä»¬å°†å‘é€é‡ç½®é“¾æ¥åˆ°æ‚¨çš„é‚®ç®±</p>
      </div>

      <div id="forgotPasswordAlert"></div>

      <form id="forgotPasswordForm">
        <div class="form-group">
          <label for="resetEmail">ğŸ“§ æ³¨å†Œé‚®ç®±</label>
          <input type="email" id="resetEmail" required placeholder="è¾“å…¥æ‚¨çš„æ³¨å†Œé‚®ç®±">
        </div>

        <button type="submit" class="btn" id="resetBtn">ğŸ“§ å‘é€é‡ç½®é“¾æ¥</button>
      </form>

      <div style="text-align: center; margin-top: 20px;">
        <a href="#" onclick="showLoginPage(); return false;" style="color: #667eea; text-decoration: none; font-size: 14px;">
          â† è¿”å›ç™»å½•
        </a>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†åå°é¡µé¢ -->
  <div id="adminPage">
    <div class="container">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <div class="header">
        <h1>ğŸ“Š USCGCC ç®¡ç†åå°</h1>
        <div class="user-info">
          <span class="user-email" id="userEmail"></span>
          <button class="btn-logout" onclick="logout()">ğŸšª é€€å‡º</button>
        </div>
      </div>

      <div id="adminAlert"></div>

      <!-- æ ‡ç­¾é¡µ -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab(event, 'knowledge')">ğŸ“š çŸ¥è¯†åº“ç®¡ç†</div>
<div class="tab" onclick="switchTab(event, 'news')">ğŸ“° åŠ¨æ€æ–°é—»</div>
<div class="tab" onclick="switchTab(event, 'settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
      </div>

      <!-- çŸ¥è¯†åº“ç®¡ç† -->
      <div id="knowledgeTab" class="tab-content active">
        <div class="stats">
          <div class="stat-card">
            <h3 id="kbTotal">-</h3>
            <p>çŸ¥è¯†åº“æ¡ç›®</p>
          </div>
          <div class="stat-card">
            <h3 id="kbWithEmbedding">-</h3>
            <p>å·²ç”Ÿæˆå‘é‡</p>
          </div>
        </div>

        <div class="card">
          <h2>â• æ·»åŠ çŸ¥è¯†åº“å†…å®¹</h2>
          <form id="knowledgeForm">
            <div class="form-group">
              <label>æ ‡é¢˜ *</label>
              <input type="text" id="kb_title" required placeholder="ä¾‹å¦‚ï¼šå•†ä¼šç®€ä»‹">
            </div>

            <div class="form-group">
              <label>åˆ†ç±» *</label>
              <select id="kb_category">
                <option value="å•†ä¼šç®€ä»‹">å•†ä¼šç®€ä»‹</option>
                <option value="æ€»ä¼šé•¿ç®€ä»‹">æ€»ä¼šé•¿ç®€ä»‹</option>
                <option value="ç§˜ä¹¦é•¿ç®€ä»‹">ç§˜ä¹¦é•¿ç®€ä»‹</option>
                <option value="å…¥ä¼šæŒ‡å—">å…¥ä¼šæŒ‡å—</option>
                <option value="åˆ›å§‹å•ä½">åˆ›å§‹å•ä½</option>
                <option value="è”ç³»æˆ‘ä»¬">è”ç³»æˆ‘ä»¬</option>
                <option value="å•†ä¼šåŠ¨æ€">å•†ä¼šåŠ¨æ€</option>
              </select>
            </div>

            <div class="form-group">
              <label>å†…å®¹ *</label>
              <textarea id="kb_content" required placeholder="è¾“å…¥å†…å®¹..."></textarea>
            </div>

            <button type="submit" class="btn">ğŸ’¾ ä¿å­˜å¹¶ç”Ÿæˆå‘é‡</button>
          </form>
        </div>

        <div class="card">
          <h2>ğŸ“‹ ç°æœ‰çŸ¥è¯†åº“</h2>
          <div id="knowledgeList" class="item-list">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- åŠ¨æ€æ–°é—»ç®¡ç† -->
      <div id="newsTab" class="tab-content">
        <div class="stats">
          <div class="stat-card">
            <h3 id="newsTotal">-</h3>
            <p>æ€»åŠ¨æ€æ•°</p>
          </div>
          <div class="stat-card">
            <h3 id="newsPublished">-</h3>
            <p>å·²å‘å¸ƒ</p>
          </div>
        </div>

        <div class="card">
          <h2>â• å‘å¸ƒæ–°åŠ¨æ€</h2>
          <form id="newsForm">
            <div class="form-group">
              <label>æ ‡é¢˜ *</label>
              <input type="text" id="news_title" required placeholder="ä¾‹å¦‚ï¼š2024 ç¾ä¸­ç»è´¸äº¤æµä¼šæˆåŠŸä¸¾åŠ">
            </div>

            <div class="form-group">
              <label>å†…å®¹ *</label>
              <textarea id="news_content" required placeholder="è¾“å…¥åŠ¨æ€å†…å®¹..."></textarea>
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label>åª’ä½“ç±»å‹</label>
                <select id="news_mediaType" onchange="toggleMediaUrl()">
                  <option value="text">çº¯æ–‡å­—</option>
                  <option value="image">å›¾ç‰‡</option>
                  <option value="video">è§†é¢‘</option>
                </select>
              </div>

              <div class="form-group">
                <label>çŠ¶æ€</label>
                <select id="news_status">
                  <option value="published">ç«‹å³å‘å¸ƒ</option>
                  <option value="draft">ä¿å­˜ä¸ºè‰ç¨¿</option>
                </select>
              </div>
            </div>

            <div class="form-group" id="mediaUrlGroup" style="display:none;">
              <label>åª’ä½“é“¾æ¥</label>
              <input type="text" id="news_mediaUrl" placeholder="å›¾ç‰‡æˆ–è§†é¢‘çš„URL">
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="news_addToKB" checked>
                åŒæ—¶æ·»åŠ åˆ°çŸ¥è¯†åº“ï¼ˆAIå¯å¼•ç”¨æ­¤åŠ¨æ€ï¼‰
              </label>
            </div>

            <button type="submit" class="btn">ğŸ“¢ å‘å¸ƒåŠ¨æ€</button>
          </form>
        </div>

        <div class="card">
          <h2>ğŸ“‹ å·²å‘å¸ƒåŠ¨æ€</h2>
          <div id="newsList" class="item-list">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>

     <!-- ç³»ç»Ÿè®¾ç½® -->
     <div id="settingsTab" class="tab-content">
      <div class="card">
        <h2>ğŸ« é‚€è¯·ç ç®¡ç†</h2>
        <p style="color:#666;margin-bottom:20px;">ç”Ÿæˆå’Œç®¡ç†æ³¨å†Œé‚€è¯·ç ï¼Œæ§åˆ¶è°å¯ä»¥æ³¨å†Œç®¡ç†å‘˜è´¦å·</p>

        <div class="form-group">
          <label>ç”Ÿæˆæ–°é‚€è¯·ç </label>
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;align-items:end;">
            <div>
              <input type="text" id="inviteDesc" placeholder="æè¿°ï¼ˆå¦‚ï¼šæ–°ç®¡ç†å‘˜ï¼‰" style="width:100%;">
            </div>
            <div>
              <input type="number" id="inviteMaxUses" value="1" min="1" placeholder="å¯ç”¨æ¬¡æ•°" style="width:100%;">
            </div>
            <div>
              <input type="number" id="inviteExpireDays" value="30" min="1" placeholder="æœ‰æ•ˆå¤©æ•°" style="width:100%;">
            </div>
            <button class="btn" onclick="generateInviteCode()" style="margin:0;">ğŸ« ç”Ÿæˆ</button>
          </div>
        </div>

        <div id="inviteCodesList" style="margin-top:20px;">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <div class="card">
        <h2>âš™ï¸ ç³»ç»Ÿä¿¡æ¯</h2>
        <p><strong>ç§Ÿæˆ·ï¼š</strong> uscgcc</p>
        <p><strong>ç‰ˆæœ¬ï¼š</strong> v1.0.0</p>
        <p><strong>AI æ¨¡å‹ï¼š</strong> gpt-4o-mini</p>
        <p><strong>å‘é‡ç»´åº¦ï¼š</strong> 1536</p>
      </div>

      <div class="card">
        <h2>ğŸ”§ ç»´æŠ¤å·¥å…·</h2>
        <button class="btn" onclick="regenerateEmbeddings()">ğŸ”„ é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡</button>
      </div>
    </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ– Supabase
    const SUPABASE_URL = 'https://hrnedqrnzqseuuxmegsb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhybmVkcXJuenFzZXV1eG1lZ3NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MDMzOTYsImV4cCI6MjA1MjA3OTM5Nn0.2AwbeB0xIdHwNILQ3Fg9dPHCEm6QczRPCFMu_hKjqPk';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    const TENANT_SLUG = 'uscgcc';

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        showAdminPage(session.user);
      }
    }

    // é¡µé¢åˆ‡æ¢å‡½æ•°
    function showLoginPage() {
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('registerPage').style.display = 'none';
      document.getElementById('forgotPasswordPage').style.display = 'none';
    }

    function showRegisterPage() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('registerPage').style.display = 'flex';
      document.getElementById('forgotPasswordPage').style.display = 'none';
    }

    function showForgotPasswordPage() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('registerPage').style.display = 'none';
      document.getElementById('forgotPasswordPage').style.display = 'flex';
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(elementId, message, type = 'error') {
      const alertDiv = document.getElementById(elementId);
      const className = type === 'error' ? 'alert-error' : 'alert-success';
      alertDiv.innerHTML = `<div class="alert ${className}">${message}</div>`;
    }

    // æ¸…é™¤æç¤ºä¿¡æ¯
    function clearAlert(elementId) {
      document.getElementById(elementId).innerHTML = '';
    }

    // ç™»å½•
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.textContent = 'ç™»å½•ä¸­...';
      clearAlert('loginAlert');

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) throw error;

         // ç™»å½•æˆåŠŸåè·³è½¬åˆ° admin-simple.html
    window.location.href = '/admin-simple.html';
      } catch (error) {
        let errorMessage = error.message;
        
        // å‹å¥½çš„é”™è¯¯æç¤º
        if (error.message.includes('Invalid login credentials')) {
          errorMessage = 'é‚®ç®±æˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
        } else if (error.message.includes('Email not confirmed')) {
          errorMessage = 'è¯·å…ˆéªŒè¯æ‚¨çš„é‚®ç®±ï¼Œæ£€æŸ¥æ”¶ä»¶ç®±ä¸­çš„ç¡®è®¤é‚®ä»¶';
        }
        
        showAlert('loginAlert', `âŒ ${errorMessage}`, 'error');
        console.error('ç™»å½•å¤±è´¥:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ” ç™»å½•';
      }
    });

    // æ³¨å†Œ
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('registerBtn');
      btn.disabled = true;
      btn.textContent = 'éªŒè¯ä¸­...';
      clearAlert('registerAlert');

      const inviteCode = document.getElementById('inviteCode').value.trim().toUpperCase();
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      const passwordConfirm = document.getElementById('regPasswordConfirm').value;

      // éªŒè¯å¯†ç 
      if (password !== passwordConfirm) {
        showAlert('registerAlert', 'âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
        btn.disabled = false;
        btn.textContent = 'ğŸ“ æ³¨å†Œ';
        return;
      }

      if (password.length < 8) {
        showAlert('registerAlert', 'âŒ å¯†ç è‡³å°‘éœ€è¦8ä½', 'error');
        btn.disabled = false;
        btn.textContent = 'ğŸ“ æ³¨å†Œ';
        return;
      }

      try {
        // 1. éªŒè¯é‚€è¯·ç 
        btn.textContent = 'éªŒè¯é‚€è¯·ç ...';
        const { data: inviteData, error: inviteError } = await supabase
          .rpc('validate_invite_code', { p_code: inviteCode });

        if (inviteError) throw new Error('é‚€è¯·ç éªŒè¯å¤±è´¥');
        
        if (!inviteData) {
          throw new Error('é‚€è¯·ç æ— æ•ˆã€å·²è¿‡æœŸæˆ–å·²è¾¾åˆ°ä½¿ç”¨ä¸Šé™');
        }

        // 2. æ³¨å†Œç”¨æˆ·
        btn.textContent = 'æ³¨å†Œä¸­...';
        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password,
          options: {
            emailRedirectTo: window.location.origin + '/admin-unified.html',
            data: {
              invite_code: inviteCode  // ä¿å­˜ä½¿ç”¨çš„é‚€è¯·ç 
            }
          }
        });

        if (error) throw error;

        // 3. è®°å½•é‚€è¯·ç ä½¿ç”¨
        await supabase.rpc('record_invite_code_usage', {
          p_code: inviteCode,
          p_email: email,
          p_user_id: data.user?.id || null
        });

        // æ³¨å†ŒæˆåŠŸ
        showAlert('registerAlert', 
          `âœ… æ³¨å†ŒæˆåŠŸï¼æˆ‘ä»¬å·²å‘é€éªŒè¯é‚®ä»¶åˆ° ${email}ï¼Œè¯·æŸ¥æ”¶å¹¶ç‚¹å‡»é“¾æ¥éªŒè¯æ‚¨çš„é‚®ç®±ã€‚`, 
          'success'
        );
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('registerForm').reset();
        
        // 3ç§’åè·³è½¬åˆ°ç™»å½•é¡µ
        setTimeout(() => {
          showLoginPage();
          showAlert('loginAlert', 'âœ… æ³¨å†ŒæˆåŠŸï¼è¯·éªŒè¯é‚®ç®±åç™»å½•', 'success');
        }, 3000);

      } catch (error) {
        let errorMessage = error.message;
        
        // å‹å¥½çš„é”™è¯¯æç¤º
        if (error.message.includes('already registered')) {
          errorMessage = 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•æˆ–ä½¿ç”¨å…¶ä»–é‚®ç®±';
        } else if (error.message.includes('é‚€è¯·ç ')) {
          errorMessage = error.message;
        }
        
        showAlert('registerAlert', `âŒ ${errorMessage}`, 'error');
        console.error('æ³¨å†Œå¤±è´¥:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“ æ³¨å†Œ';
      }
    });

    // å¿˜è®°å¯†ç 
    document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('resetBtn');
      btn.disabled = true;
      btn.textContent = 'å‘é€ä¸­...';
      clearAlert('forgotPasswordAlert');

      const email = document.getElementById('resetEmail').value;

      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + '/admin-unified.html'
        });

        if (error) throw error;

        // å‘é€æˆåŠŸ
        showAlert('forgotPasswordAlert', 
          `âœ… é‡ç½®é“¾æ¥å·²å‘é€åˆ° ${email}ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶å¹¶ç‚¹å‡»é“¾æ¥é‡ç½®å¯†ç ã€‚`, 
          'success'
        );
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('forgotPasswordForm').reset();

      } catch (error) {
        showAlert('forgotPasswordAlert', `âŒ ${error.message}`, 'error');
        console.error('å‘é€é‡ç½®é‚®ä»¶å¤±è´¥:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“§ å‘é€é‡ç½®é“¾æ¥';
      }
    });

    // æ˜¾ç¤ºç®¡ç†é¡µé¢
    function showAdminPage(user) {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('adminPage').style.display = 'block';
      document.getElementById('userEmail').textContent = user.email;
      
      loadAllData();
    }

    // é€€å‡ºç™»å½•
    async function logout() {
      await supabase.auth.signOut();
      location.reload();
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(e, tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  if (e && e.target) e.target.classList.add('active');
  document.getElementById(tab + 'Tab').classList.add('active');
}

    // åŠ è½½æ‰€æœ‰æ•°æ®
    async function loadAllData() {
      loadKnowledgeStats();
      loadKnowledgeList();
      loadNewsStats();
      loadNewsList();
      loadInviteCodes();
    }

    // ... (åç»­ä»£ç åœ¨ä¸‹ä¸€ä¸ªæ–‡ä»¶ä¸­ç»§ç»­)

    // çŸ¥è¯†åº“ç»Ÿè®¡
    async function loadKnowledgeStats() {
      const { data } = await supabase
        .from('knowledge_base')
        .select('id, embedding')
        .eq('tenant_slug', TENANT_SLUG);
      
      document.getElementById('kbTotal').textContent = data?.length || 0;
      document.getElementById('kbWithEmbedding').textContent = 
        data?.filter(i => i.embedding).length || 0;
    }

    // çŸ¥è¯†åº“åˆ—è¡¨
    async function loadKnowledgeList() {
      const listDiv = document.getElementById('knowledgeList');
      listDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      const { data, error } = await supabase
        .from('knowledge_base')
        .select('*')
        .eq('tenant_slug', TENANT_SLUG)
        .order('created_at', { ascending: false });

      if (error || !data || data.length === 0) {
        listDiv.innerHTML = '<p style="text-align:center;color:#666;">æš‚æ— çŸ¥è¯†åº“</p>';
        return;
      }

      listDiv.innerHTML = data.map(item => `
        <div class="item">
          <h3>
            ${item.title}
            <span class="badge badge-success">${item.category || 'æœªåˆ†ç±»'}</span>
            ${item.embedding ? '<span class="badge badge-success">âœ“ å·²ç”Ÿæˆå‘é‡</span>' : ''}
          </h3>
          <p>${(item.content || '').substring(0, 150)}...</p>
          <div class="item-meta">
            <span>ğŸ“… ${new Date(item.created_at).toLocaleString('zh-CN')}</span>
          </div>
          <div class="actions">
            <button class="btn btn-sm btn-danger" onclick="deleteKnowledge('${item.id}', '${item.title}')">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    // æ–°é—»ç»Ÿè®¡
    async function loadNewsStats() {
      const { data } = await supabase
        .from('news')
        .select('id, status')
        .eq('tenant_slug', TENANT_SLUG);
      
      document.getElementById('newsTotal').textContent = data?.length || 0;
      document.getElementById('newsPublished').textContent = 
        data?.filter(i => i.status === 'published').length || 0;
    }

    // æ–°é—»åˆ—è¡¨
    async function loadNewsList() {
      const listDiv = document.getElementById('newsList');
      listDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      const { data, error } = await supabase
        .from('news')
        .select('*')
        .eq('tenant_slug', TENANT_SLUG)
        .order('published_at', { ascending: false });

      if (error || !data || data.length === 0) {
        listDiv.innerHTML = '<p style="text-align:center;color:#666;">æš‚æ— åŠ¨æ€</p>';
        return;
      }

      listDiv.innerHTML = data.map(item => `
        <div class="item">
          <h3>
            ${item.title}
            <span class="badge ${item.status === 'published' ? 'badge-success' : 'badge-warning'}">
              ${item.status === 'published' ? 'âœ“ å·²å‘å¸ƒ' : 'ğŸ“ è‰ç¨¿'}
            </span>
          </h3>
          <p>${(item.content || '').substring(0, 150)}...</p>
          <div class="item-meta">
            <span>ğŸ“… ${new Date(item.published_at).toLocaleString('zh-CN')}</span>
          </div>
          <div class="actions">
            <button class="btn btn-sm btn-danger" onclick="deleteNews('${item.id}', '${item.title}')">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    // æäº¤çŸ¥è¯†åº“
    document.getElementById('knowledgeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('kb_title').value;
      const category = document.getElementById('kb_category').value;
      const content = document.getElementById('kb_content').value;

      try {
        const { error } = await supabase
          .from('knowledge_base')
          .insert([{ tenant_slug: TENANT_SLUG, title, category, content, content_type: 'text' }]);

        if (error) throw error;

        // ç”Ÿæˆå‘é‡
        await supabase.functions.invoke('embed-backfill', {
          body: { tenant_slug: TENANT_SLUG, limit: 50 }
        });

        showAdminAlert('âœ… çŸ¥è¯†åº“æ·»åŠ æˆåŠŸï¼', 'success');
        document.getElementById('knowledgeForm').reset();
        loadKnowledgeStats();
        loadKnowledgeList();
      } catch (error) {
        showAdminAlert('âŒ æ·»åŠ å¤±è´¥: ' + error.message, 'error');
      }
    });

    // æäº¤æ–°é—»ï¼ˆåŒæ—¶æ·»åŠ åˆ°çŸ¥è¯†åº“ï¼‰
    document.getElementById('newsForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('news_title').value;
      const content = document.getElementById('news_content').value;
      const mediaType = document.getElementById('news_mediaType').value;
      const mediaUrl = document.getElementById('news_mediaUrl').value;
      const status = document.getElementById('news_status').value;
      const addToKB = document.getElementById('news_addToKB').checked;

      try {
        // 1. æ’å…¥æ–°é—»
        const { data: newsData, error: newsError } = await supabase
          .from('news')
          .insert([{
            tenant_slug: TENANT_SLUG,
            title,
            content,
            media_type: mediaType,
            media_url: mediaUrl || null,
            status
          }])
          .select();

        if (newsError) throw newsError;

        // 2. å¦‚æœå‹¾é€‰äº†"æ·»åŠ åˆ°çŸ¥è¯†åº“"
        if (addToKB && status === 'published') {
          await supabase
            .from('knowledge_base')
            .insert([{
              tenant_slug: TENANT_SLUG,
              title: title,
              content: content,
              category: 'å•†ä¼šåŠ¨æ€',
              content_type: 'text',
              source_url: mediaUrl || null
            }]);

          // ç”Ÿæˆå‘é‡
          await supabase.functions.invoke('embed-backfill', {
            body: { tenant_slug: TENANT_SLUG, limit: 50 }
          });
        }

        showAdminAlert('âœ… åŠ¨æ€å‘å¸ƒæˆåŠŸ' + (addToKB ? 'ï¼Œå·²æ·»åŠ åˆ°çŸ¥è¯†åº“ï¼' : 'ï¼'), 'success');
        document.getElementById('newsForm').reset();
        loadNewsStats();
        loadNewsList();
        if (addToKB) {
          loadKnowledgeStats();
          loadKnowledgeList();
        }
      } catch (error) {
        showAdminAlert('âŒ å‘å¸ƒå¤±è´¥: ' + error.message, 'error');
      }
    });

    // åˆ é™¤çŸ¥è¯†åº“
    async function deleteKnowledge(id, title) {
      if (!confirm(`ç¡®å®šåˆ é™¤"${title}"ï¼Ÿ`)) return;

      const { error } = await supabase
        .from('knowledge_base')
        .delete()
        .eq('id', id);

      if (!error) {
        showAdminAlert('âœ… å·²åˆ é™¤', 'success');
        loadKnowledgeStats();
        loadKnowledgeList();
      }
    }

    // åˆ é™¤æ–°é—»
    async function deleteNews(id, title) {
      if (!confirm(`ç¡®å®šåˆ é™¤"${title}"ï¼Ÿ`)) return;

      const { error } = await supabase
        .from('news')
        .delete()
        .eq('id', id);

      if (!error) {
        showAdminAlert('âœ… å·²åˆ é™¤', 'success');
        loadNewsStats();
        loadNewsList();
      }
    }

    // é‡æ–°ç”Ÿæˆå‘é‡
    async function regenerateEmbeddings() {
      if (!confirm('ç¡®å®šé‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡å—ï¼Ÿ')) return;

      try {
        await supabase.functions.invoke('embed-backfill', {
          body: { tenant_slug: TENANT_SLUG, limit: 100 }
        });
        showAdminAlert('âœ… å‘é‡ç”ŸæˆæˆåŠŸï¼', 'success');
        loadKnowledgeStats();
      } catch (error) {
        showAdminAlert('âŒ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºæç¤º
    function showAdminAlert(message, type) {
      document.getElementById('adminAlert').innerHTML = `
        <div class="alert alert-${type}">${message}</div>
      `;
      setTimeout(() => {
        document.getElementById('adminAlert').innerHTML = '';
      }, 5000);
    }

    // åˆ‡æ¢åª’ä½“URLæ˜¾ç¤º
    function toggleMediaUrl() {
      const mediaType = document.getElementById('news_mediaType').value;
      document.getElementById('mediaUrlGroup').style.display = 
        (mediaType === 'image' || mediaType === 'video') ? 'block' : 'none';
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•
    checkAuth();

    // ========================================
    // é‚€è¯·ç ç®¡ç†åŠŸèƒ½
    // ========================================
    
    // åŠ è½½é‚€è¯·ç åˆ—è¡¨
    async function loadInviteCodes() {
      const listDiv = document.getElementById('inviteCodesList');
      listDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const { data, error } = await supabase
          .from('invite_codes')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          listDiv.innerHTML = '<p style="text-align:center;color:#666;">æš‚æ— é‚€è¯·ç </p>';
          return;
        }

        listDiv.innerHTML = data.map(item => {
          const isExpired = item.expires_at && new Date(item.expires_at) < new Date();
          const isExhausted = item.max_uses && item.used_count >= item.max_uses;
          const isValid = item.is_active && !isExpired && !isExhausted;

          return `
            <div class="item">
              <h3>
                <code style="background:#f0f0f0;padding:5px 10px;border-radius:4px;font-size:16px;">${item.code}</code>
                <span class="badge ${isValid ? 'badge-success' : 'badge-warning'}">
                  ${isValid ? 'âœ“ æœ‰æ•ˆ' : 'âŒ å¤±æ•ˆ'}
                </span>
              </h3>
              <p>${item.description || 'æ— æè¿°'}</p>
              <div class="item-meta">
                <span>ğŸ“Š å·²ä½¿ç”¨: ${item.used_count}/${item.max_uses || 'âˆ'}</span>
                <span>â° ${item.expires_at ? 'è¿‡æœŸ: ' + new Date(item.expires_at).toLocaleDateString('zh-CN') : 'æ°¸ä¹…æœ‰æ•ˆ'}</span>
                <span>ğŸ“… åˆ›å»º: ${new Date(item.created_at).toLocaleDateString('zh-CN')}</span>
              </div>
              <div class="actions">
                <button class="btn btn-sm" onclick="copyInviteCode('${item.code}')">ğŸ“‹ å¤åˆ¶</button>
                <button class="btn btn-sm ${item.is_active ? 'btn-secondary' : 'btn-success'}" onclick="toggleInviteCode('${item.id}', ${!item.is_active})">
                  ${item.is_active ? 'ğŸš« ç¦ç”¨' : 'âœ… å¯ç”¨'}
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteInviteCode('${item.id}', '${item.code}')">ğŸ—‘ï¸ åˆ é™¤</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('åŠ è½½é‚€è¯·ç å¤±è´¥:', error);
        listDiv.innerHTML = '<p style="text-align:center;color:red;">åŠ è½½å¤±è´¥</p>';
      }
    }

    // ç”Ÿæˆé‚€è¯·ç 
    async function generateInviteCode() {
      const desc = document.getElementById('inviteDesc').value || 'æœªå‘½å';
      const maxUses = parseInt(document.getElementById('inviteMaxUses').value) || 1;
      const expireDays = parseInt(document.getElementById('inviteExpireDays').value) || 30;

      try {
        const { data, error } = await supabase
          .rpc('generate_invite_code', {
            p_description: desc,
            p_max_uses: maxUses,
            p_expires_days: expireDays
          });

        if (error) throw error;

        showAdminAlert(`âœ… é‚€è¯·ç å·²ç”Ÿæˆ: ${data}`, 'success');
        
        // æ¸…ç©ºè¾“å…¥
        document.getElementById('inviteDesc').value = '';
        document.getElementById('inviteMaxUses').value = '1';
        document.getElementById('inviteExpireDays').value = '30';
        
        // åˆ·æ–°åˆ—è¡¨
        loadInviteCodes();
        
        // è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(data).then(() => {
          showAdminAlert(`âœ… é‚€è¯·ç å·²ç”Ÿæˆå¹¶å¤åˆ¶: ${data}`, 'success');
        });
      } catch (error) {
        showAdminAlert('âŒ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
      }
    }

    // å¤åˆ¶é‚€è¯·ç 
    function copyInviteCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        showAdminAlert(`âœ… å·²å¤åˆ¶: ${code}`, 'success');
      });
    }

    // åˆ‡æ¢é‚€è¯·ç çŠ¶æ€
    async function toggleInviteCode(id, newStatus) {
      const { error } = await supabase
        .from('invite_codes')
        .update({ is_active: newStatus })
        .eq('id', id);

      if (!error) {
        showAdminAlert(`âœ… ${newStatus ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`, 'success');
        loadInviteCodes();
      }
    }

    // åˆ é™¤é‚€è¯·ç 
    async function deleteInviteCode(id, code) {
      if (!confirm(`ç¡®å®šåˆ é™¤é‚€è¯·ç  "${code}" å—ï¼Ÿ`)) return;

      const { error } = await supabase
        .from('invite_codes')
        .delete()
        .eq('id', id);

      if (!error) {
        showAdminAlert('âœ… å·²åˆ é™¤', 'success');
        loadInviteCodes();
      }
    }
  </script>
</body>
</html>
